{% if render_table_only %}
<div id="table-container">
  <table class="table table-striped">
    <thead>
      <tr>
        <th>ç”¨æˆ¶åç¨±</th>
        <th>é›»å­éƒµä»¶</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr>
        <td>{{ user.username }}</td>
        <td>{{ user.email }}</td>
        <td>
          <button
            type="button"
            class="btn btn-warning edit-user"
            data-user-id="{{ user.id }}"
            data-bs-toggle="modal"
            data-bs-target="#editUserModal"
          >ç·¨è¼¯</button>
          <button
            type="button"
            class="btn btn-danger delete-user"
            data-user-id="{{ user.id }}"
          >åˆªé™¤</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>ä½¿ç”¨è€…ç®¡ç†ç³»çµ±</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body class="container mt-5">
    <div id="main-container">
      <h2>ç”¨æˆ¶ç®¡ç†</h2>
      <button
        type="button"
        class="btn btn-primary mb-3"
        data-bs-toggle="modal"
        data-bs-target="#addUserModal"
      >
        â• æ–°å¢ç”¨æˆ¶
      </button>
      <div id="table-container">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>ç”¨æˆ¶åç¨±</th>
              <th>é›»å­éƒµä»¶</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr>
              <td>{{ user.username }}</td>
              <td>{{ user.email }}</td>
              <td>
                <button
                  type="button"
                  class="btn btn-warning edit-user"
                  data-user-id="{{ user.id }}"
                  data-bs-toggle="modal"
                  data-bs-target="#editUserModal"
                >ç·¨è¼¯</button>
                <button
                  type="button"
                  class="btn btn-danger delete-user"
                  data-user-id="{{ user.id }}"
                >åˆªé™¤</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- æ–°å¢ç”¨æˆ¶çš„ Modal -->
    <div
      class="modal fade"
      id="addUserModal"
      tabindex="-1"
      aria-labelledby="addUserModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addUserModalLabel">ğŸ“ˆ æ–°å¢ç”¨æˆ¶</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addUserForm" method="post">
              {% csrf_token %}
              <div class="mb-3">
                {{ form.username.label_tag }}
                {{ form.username }}
                <div class="invalid-feedback" id="username-error"></div>
              </div>
              <div class="mb-3">
                {{ form.email.label_tag }}
                {{ form.email }}
                <div class="invalid-feedback" id="email-error"></div>
              </div>
              <div class="mb-3">
                {{ form.password1.label_tag }}
                {{ form.password1 }}
                <div class="invalid-feedback" id="password1-error"></div>
              </div>
              <div class="mb-3">
                {{ form.password2.label_tag }}
                {{ form.password2 }}
                <div class="invalid-feedback" id="password2-error"></div>
              </div>
              <div id="error-container" class="alert alert-danger d-none"></div>
              <button type="submit" class="btn btn-success w-100">
                ç¢ºèªæ–°å¢
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- ç·¨è¼¯ç”¨æˆ¶çš„ Modal -->
    <div
      class="modal fade"
      id="editUserModal"
      tabindex="-1"
      aria-labelledby="editUserModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editUserModalLabel">âœï¸ ç·¨è¼¯ç”¨æˆ¶</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editUserForm" method="post">
              {% csrf_token %}
              <input type="hidden" id="edit-user-id" name="user_id" value="">
              <div class="mb-3">
                <label for="edit-username" class="form-label">ç”¨æˆ¶åç¨±</label>
                <input type="text" class="form-control" id="edit-username" name="username">
                <div class="invalid-feedback" id="edit-username-error"></div>
              </div>
              <div class="mb-3">
                <label for="edit-email" class="form-label">é›»å­éƒµä»¶</label>
                <input type="email" class="form-control" id="edit-email" name="email">
                <div class="invalid-feedback" id="edit-email-error"></div>
              </div>
              <div id="edit-error-container" class="alert alert-danger d-none"></div>
              <button type="submit" class="btn btn-success w-100">
                ç¢ºèªä¿®æ”¹
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // æ›´æ–°è¡¨æ ¼å…§å®¹çš„å‡½æ•¸
      function updateTableContent(html) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        document.getElementById('table-container').replaceWith(tempDiv.firstElementChild);
        
        // é‡æ–°åˆå§‹åŒ–æ‰€æœ‰äº‹ä»¶ç›£è½å™¨
        initializeEventListeners();
      }

      // å°‡æ‰€æœ‰äº‹ä»¶ç›£è½å™¨åˆå§‹åŒ–å°è£æˆä¸€å€‹å‡½æ•¸
      function initializeEventListeners() {
        // æ–°å¢ç”¨æˆ¶è¡¨å–®æäº¤
        const addForm = document.getElementById("addUserForm");
        if (addForm) {
          addForm.addEventListener("submit", function (event) {
            event.preventDefault();
            // é‡ç½®é”™è¯¯æ˜¾ç¤º
            document.querySelectorAll('.invalid-feedback').forEach(el => {
              el.textContent = '';
              el.style.display = 'none';
            });
            document.getElementById('error-container').classList.add('d-none');
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            let formData = new FormData(this);
            fetch("{% url 'add_user' %}", {
              method: "POST",
              body: formData,
              headers: {
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": csrfToken
              },
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  // å…ˆé—œé–‰ Modal
                  const modalElement = document.getElementById('addUserModal');
                  const modal = bootstrap.Modal.getInstance(modalElement);
                  if (modal) {
                    modal.hide();
                  }
                  
                  // é‡ç½®è¡¨å–®
                  addForm.reset();
                  
                  // æ›´æ–°è¡¨æ ¼å…§å®¹
                  updateTableContent(data.html);
                } else {
                  // æ˜¾ç¤ºå­—æ®µç‰¹å®šçš„é”™è¯¯
                  if (typeof data.errors === 'object') {
                    Object.keys(data.errors).forEach(field => {
                      const errorElement = document.getElementById(`${field}-error`);
                      if (errorElement) {
                        errorElement.textContent = data.errors[field].join(', ');
                        errorElement.style.display = 'block';
                      }
                    });
                  } else {
                    // æ˜¾ç¤ºä¸€èˆ¬é”™è¯¯
                    const errorContainer = document.getElementById("error-container");
                    errorContainer.classList.remove("d-none");
                    errorContainer.innerHTML = Array.isArray(data.errors) ? data.errors.join("<br>") : data.errors;
                  }
                }
              })
              .catch((error) => {
                console.error("There was a problem with the fetch operation:", error);
                const errorContainer = document.getElementById("error-container");
                errorContainer.classList.remove("d-none");
                errorContainer.innerHTML = "ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦";
              });
          });
        }

        // ç·¨è¼¯ç”¨æˆ¶åŠŸèƒ½
        document.querySelectorAll('.edit-user').forEach(button => {
          button.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            document.getElementById('edit-user-id').value = userId;
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            // ç²å–ç”¨æˆ¶æ•¸æ“š
            fetch(`/user/get/${userId}/`, {
              headers: {
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": csrfToken
              }
            })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  document.getElementById('edit-username').value = data.user.username;
                  document.getElementById('edit-email').value = data.user.email;
                }
              });
          });
        });

        // ç·¨è¼¯ç”¨æˆ¶è¡¨å–®æäº¤
        const editForm = document.getElementById('editUserForm');
        if (editForm) {
          editForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const userId = document.getElementById('edit-user-id').value;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            let formData = new FormData(this);
            fetch(`/user/edit/${userId}/`, {
              method: 'POST',
              body: formData,
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
              }
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                // å…ˆé—œé–‰ Modal
                const modalElement = document.getElementById('editUserModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                  modal.hide();
                }
                
                // æ›´æ–°è¡¨æ ¼å…§å®¹
                updateTableContent(data.html);
              } else {
                if (typeof data.errors === 'object') {
                  Object.keys(data.errors).forEach(field => {
                    const errorElement = document.getElementById(`edit-${field}-error`);
                    if (errorElement) {
                      errorElement.textContent = data.errors[field].join(', ');
                      errorElement.style.display = 'block';
                    }
                  });
                } else {
                  const errorContainer = document.getElementById('edit-error-container');
                  errorContainer.classList.remove('d-none');
                  errorContainer.innerHTML = Array.isArray(data.errors) ? data.errors.join('<br>') : data.errors;
                }
              }
            });
          });
        }

        // åˆªé™¤ç”¨æˆ¶åŠŸèƒ½
        document.querySelectorAll('.delete-user').forEach(button => {
          button.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç”¨æˆ¶å—ï¼Ÿ')) {
              const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
              fetch(`/user/delete/${userId}/`, {
                method: 'POST',
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                  'X-CSRFToken': csrfToken
                },
                credentials: 'same-origin'
              })
              .then(response => {
                if (!response.ok) {
                  throw new Error('Network response was not ok');
                }
                return response.json();
              })
              .then(data => {
                if (data.success) {
                  // æ›´æ–°è¡¨æ ¼å…§å®¹
                  updateTableContent(data.html);
                } else {
                  alert('åˆªé™¤å¤±æ•—ï¼š' + (Array.isArray(data.errors) ? data.errors.join(', ') : data.errors));
                }
              })
              .catch(error => {
                console.error('Error:', error);
                alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
              });
            }
          });
        });
      }

      // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–æ‰€æœ‰äº‹ä»¶ç›£è½å™¨
      initializeEventListeners();
    </script>
  </body>
</html>
{% endif %}
